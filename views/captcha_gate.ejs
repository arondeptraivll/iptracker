<%- include('partials/header_vietnamese') %>

<div class="container" style="text-align: center; margin-top: 15vh;">
    <article id="captcha-article">
        <hgroup>
            <h1>Yêu cầu Xác thực</h1>
            <p>Để tiếp tục, vui lòng xác nhận bạn không phải là robot.</p>
        </hgroup>

        <!-- Form sẽ được gửi đi bằng JavaScript khi captcha được giải -->
        <form id="captcha-form" action="/t/<%= shortId %>/verify" method="POST">
             <div id="hcaptcha-container" style="display: inline-block;">
                <div class="h-captcha"
                    data-sitekey="<%= hcaptcha_site_key %>"
                    data-callback="onCaptchaSolved"
                    data-error-callback="onCaptchaError">
                </div>
             </div>
             <!-- Fallback cho trường hợp JavaScript bị vô hiệu hóa -->
             <noscript>
                <p>Vui lòng bật JavaScript để có thể giải Captcha.</p>
             </noscript>
        </form>
        
        <div id="loading-container" style="display: none; margin-top: 1rem;">
             <p>Đang xác thực, vui lòng chờ...</p>
             <progress></progress>
        </div>
        
        <div id="error-message" style="color: var(--pico-color-red-500); margin-top: 1rem;"></div>
    </article>
</div>

<script>
    function onCaptchaSolved(token) {
        // Lấy các element cần thiết
        const form = document.getElementById('captcha-form');
        const hcaptchaContainer = document.getElementById('hcaptcha-container');
        const loadingContainer = document.getElementById('loading-container');
        const errorMessage = document.getElementById('error-message');

        // Ẩn thông báo lỗi cũ nếu có
        errorMessage.textContent = '';
        
        // ---- FIX LỖI Ở ĐÂY ----
        // 1. Ẩn hộp captcha và hiển thị trạng thái đang tải
        hcaptchaContainer.style.display = 'none';
        loadingContainer.style.display = 'block';

        // 2. Tạo một input ẩn CHỨA TOKEN và thêm vào form.
        // Dòng này rất quan trọng vì đây là cách token được gửi lên server.
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'h-captcha-response';
        input.value = token;
        form.appendChild(input);

        // 3. Gửi form đi. 
        // Form bây giờ vẫn còn nguyên vẹn và chứa token captcha hợp lệ.
        form.submit();
    }

    function onCaptchaError(err) {
        console.error('Lỗi hCaptcha cho khách truy cập:', err);
        const errorContainer = document.getElementById('error-message');
        errorContainer.textContent = 'Đã xảy ra lỗi với Captcha. Vui lòng tải lại trang và thử lại.';
    }
</script>

<%- include('partials/footer_vietnamese') %>
