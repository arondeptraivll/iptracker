<%- include('partials/header_vietnamese') %>

<nav>
  <ul>
    <li><strong>IP Tracker</strong> by Gemlogin Tool (TuanHaii)</li>
  </ul>
  <ul>
    <li><a href="/key" role="button" class="contrast">Quản lý Key</a></li>
    <li>
      <details role="list" dir="rtl">
        <summary aria-haspopup="listbox" role="link">
            <img src="<%= user.avatar %>" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; vertical-align: middle;">
             <%= user.username %>
        </summary>
        <ul role="listbox">
          <li><a href="/auth/logout">Đăng xuất</a></li>
        </ul>
      </details>
    </li>
  </ul>
</nav>

<!-- THÔNG BÁO YÊU CẦU KEY -->
<% if (!hasActiveKey) { %>
    <div class="toast error" style="margin-top:1rem;">
        Key của bạn chưa được kích hoạt hoặc đã hết hạn. Vui lòng vào trang <b>Quản lý Key</b> để lấy và kích hoạt lại. Các tính năng chính đã bị tạm khóa.
    </div>
<% } %>


<!-- Vô hiệu hóa form tạo link khi không có key -->
<fieldset <%= !hasActiveKey ? 'disabled' : '' %> >
  <hgroup>
    <h2>Tạo liên kết theo dõi mới</h2>
    <p>Nhập URL đích. Chúng tôi sẽ tạo một liên kết mới để bạn chia sẻ.</p>
  </hgroup>
  
  <form action="/create-link" method="POST">
    <input type="url" name="targetUrl" placeholder="https://url-dich-cua-ban.com" required>
    <button type="submit">Tạo liên kết</button>
  </form>
</fieldset>

<hr>

<h2>Liên kết & Kết quả của bạn</h2>
<small><em>Lưu ý: Các liên kết không có lượt truy cập nào trong 2 ngày sẽ tự động bị xóa.</em></small>

<% if (links.length === 0) { %>
    <p>Bạn chưa tạo liên kết nào. Hãy tạo một liên kết ở trên!</p>
<% } else { %>
    <% links.forEach(link => { %>
        <article>
            <header style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Liên kết theo dõi:</strong> 
                    <code style="cursor: pointer;" onclick="navigator.clipboard.writeText('<%= baseUrl %>/t/<%= link.shortId %>'); showToast('Đã sao chép liên kết!');"><%= baseUrl %>/t/<%= link.shortId %></code>
                </div>
                <form action="/delete-link/<%= link.shortId %>" method="POST" onsubmit="return confirm('Bạn có chắc muốn xóa liên kết này và tất cả kết quả của nó không?');">
                    <button type="submit" class="secondary outline" style="padding: 5px 10px; margin: 0;">Xóa Liên kết</button>
                </form>
            </header>
            <p><strong>URL Đích:</strong> <a href="<%= link.targetUrl %>" target="_blank"><%= link.targetUrl %></a></p>
            
            <% if (link.Visits && link.Visits.length > 0) { %>
                <div class="overflow-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>ID Thiết bị</th>
                                <th>Địa chỉ IP</th>
                                <th>Thời gian</th>
                                <th style="text-align: right;">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% link.Visits.forEach(visit => { %>
                                <tr id="visit-row-<%= visit.id %>">
                                    <td><code><%= visit.fingerprintId %></code></td>
                                    <td><%= visit.ipAddress %></td>
                                    <td><%= new Date(visit.timestamp).toLocaleString('vi-VN') %></td>
                                    <td style="text-align: right;">
                                        <!-- Vô hiệu hóa nút Chi tiết khi không có key -->
                                        <a href="<%= hasActiveKey ? '/details/' + visit.id : '#' %>" 
                                           role="button" class="contrast" 
                                           <%= !hasActiveKey ? 'aria-disabled="true"' : '' %>
                                           onclick="<%= !hasActiveKey ? "showToast('Vui lòng kích hoạt Key để xem chi tiết.', 'error'); return false;" : "" %>"
                                           style="padding: 5px 10px; margin:0 5px 0 0;">
                                           Chi tiết
                                        </a>
                                        <!-- Nút xóa không bị ảnh hưởng -->
                                        <a href="#" role="button" class="secondary" style="padding: 5px 10px; margin:0;" onclick="deleteVisit(event, '<%= visit.id %>')">
                                           Xóa
                                        </a>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <p><em>Chưa có lượt truy cập nào cho liên kết này.</em></p>
            <% } %>
        </article>
    <% }) %>
<% } %>

<!-- Vùng hiển thị Toast thông báo -->
<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<%- include('partials/footer_vietnamese') %>

<script>
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.style.marginBottom = "10px";

        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s ease';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    async function deleteVisit(event, visitId) {
        event.preventDefault();
        if (!confirm('Bạn có chắc muốn xóa kết quả này không?')) {
            return;
        }
        try {
            const response = await fetch(`/delete-visit/${visitId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
                document.getElementById(`visit-row-${visitId}`)?.remove();
                showToast('Đã xóa kết quả thành công.', 'success');
            } else {
                showToast(`Lỗi: ${result.message}`, 'error');
            }
        } catch (error) {
            showToast('Đã xảy ra lỗi khi cố gắng xóa kết quả.', 'error');
        }
    }
</script>
