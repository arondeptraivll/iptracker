<!DOCTYPE html>
<html>
<head>
    <title>Đang chuyển hướng...</title>
    <!-- Tải thư viện FingerprintJS -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body>
    <p>Vui lòng chờ trong khi chúng tôi chuyển hướng bạn...</p>

    <script>
        async function runTracker() {
            const targetUrl = '<%= targetUrl %>';
            const shortId = '<%= shortId %>';

            try {
                const fp = await FingerprintJS.load();
                const result = await fp.get();

                // Lấy cả chuỗi hash và đối tượng chi tiết
                const visitorId = result.visitorId;
                const components = result.components;

                // Gửi cả 2 về server
                await fetch('/log', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shortId: shortId,
                        fingerprint: visitorId,
                        components: components // GỬI THÊM ĐỐI TƯỢNG components
                    })
                });

            } catch (error) {
                console.error("Lỗi Fingerprinting:", error);
            } finally {
                // Luôn chuyển hướng người dùng đến đích
                window.location.href = targetUrl;
            }
        }
        
        runTracker();
    </script>
</body>
</html>
